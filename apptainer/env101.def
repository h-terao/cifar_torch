Bootstrap: docker
From: ubuntu:20.04

%files
    requirements.txt ./

%help
    Build CUDA10.1 and PyTorch on Ubuntu20.04

%environment
    export TZ=Asia/Tokyo
    export PYTHONDONTWRITEBYTECODE=1
    export PATH="/usr/local/cuda/bin:$PATH"
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"

%post
    rm -rf /var/lib/apt/lists/*
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata software-properties-common

    apt-get update
    add-apt-repository -y ppa:graphics-drivers
    apt-key adv --fetch-keys http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub
    bash -c 'echo "deb http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64 /" > /etc/apt/sources.list.d/cuda.list'
    bash -c 'echo "deb http://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64 /" > /etc/apt/sources.list.d/cuda_learn.list'

    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y cuda-10-1 libcudnn7 wget curl git nano \
        python3-dev python3-pip python-is-python3 git pkg-config ccache unzip

    pip3 install torch==1.7.1+cu101 torchvision==0.8.2+cu101 -f https://download.pytorch.org/whl/torch_stable.html
    pip3 install -r requirements.txt

%labels
    Author Terao Hayato
    Version v0.1
